mkdir centos
cd centos

cat > yum.conf <<- EOF
[main]
cachedir=$PWD/yum.cache
keepcache=0
logfile=$PWD/yum.log
metadata_expire=never
plugins=1
debuglevel=3
errorlevel=6
reposdir=$PWD/yum.repos.d
EOF

mkdir yum.repos.d
cat > yum.repos.d/os.repo <<- EOF
[os]
name=os
baseurl=ftp://172.16.15.29/os/centos/os/ppc64le
enabled=1
gpgcheck=0

[update]
name=update
baseurl=ftp://172.16.15.29/os/centos/updates/ppc64le
enabled=1
gpgcheck=0

[epel]
name=epel
baseurl=ftp://172.16.15.29/os/rhel/epel/7/ppc64le
enabled=1
gpgcheck=0
EOF

mkdir os
mkdir -m 755 os/dev
mknod -m 600 os/dev/console c 5 1
mknod -m 600 os/dev/initctl p
mknod -m 666 os/dev/full c 1 7
mknod -m 666 os/dev/null c 1 3
mknod -m 666 os/dev/ptmx c 5 2
mknod -m 666 os/dev/random c 1 8
mknod -m 666 os/dev/tty c 5 0
mknod -m 666 os/dev/tty0 c 4 0
mknod -m 666 os/dev/urandom c 1 9
mknod -m 666 os/dev/zero c 1 5

yum -y \
    -c yum.conf \
    --installroot=$PWD/os \
    --releasever=/ \
    --setopt=tsflags=nodocs \
    --setopt=group_package_types=mandatory \
    install bash iputils less passwd rootfiles systemd tar vim-minimal yum yum-utils yum-plugin-ovl which
    #https://github.com/CentOS/sig-cloud-instance-images/issues/15
    #groupinstall Core
yum -y \
    -c yum.conf \
    --installroot=$PWD/os \
    remove groff-base
yum -y \
    -c yum.conf \
    --installroot=$PWD/os \
    clean all

cat > os/etc/sysconfig/network <<EOF
NETWORKING=yes
HOSTNAME=localhost.localdomain
EOF

rm -f os/etc/yum.repos.d/*
cat > os/etc/yum.repos.d/os.repo <<- 'EOF'
[os]
name=os
baseurl=ftp://172.16.15.29/os/centos/os/ppc64le
enabled=1
gpgcheck=0

[update]
name=update
baseurl=ftp://172.16.15.29/os/centos/updates/ppc64le
enabled=1
gpgcheck=0

[epel]
name=epel
baseurl=ftp://172.16.15.29/os/rhel/epel/7/ppc64le
enabled=1
gpgcheck=0
EOF

rm -rf \
  os/usr/{{lib,share}/locale,{lib,lib64}/gconv,bin/localedef,sbin/build-locale-archive} \
  os/usr/share/{man,doc,info,gnome/help} \
  os/usr/share/cracklib \
  os/usr/share/i18n \
  os/sbin/sln \
  os/etc/ld.so.cache \
  os/var/cache/ldconfig/*

echo 'rm -f /var/lib/rpm/__db*; rpm --rebuilddb; yum clean all' > os/root/rpmdb_rebuild.sh
#chroot os /bin/bash -c "bash /root/rpmdb_rebuild.sh"
rm -rf os/root/work/

tar --numeric-owner --create --auto-compress --file rootfs.tar.xz --directory os --transform='s,^./,,' .

rm -rf os yum.conf yum.repos.d yum.cache yum.log

cat > centos-Dockerfile <<- 'EOF'
FROM scratch
MAINTAINER JunLi Zhang<junlizh@cn.ibm.com>

ADD rootfs.tar.xz /

CMD ["/bin/bash"]
EOF

docker build -t ppc64le/centos:7.3 -f centos-Dockerfile .
